<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InfoMela Video & Banner Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Noto+Sans+Bengali:wght@600;700&display=swap" rel="stylesheet">
  <style>
    /* Base Styles */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 30px;
      color: #fff;
    }
    .main-container {
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 40px;
    }

    /* Control Panel */
    .control-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 35px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);      position: sticky;
      top: 30px;
      max-height: 95vh;
      overflow-y: auto;
    }
    .control-panel h1 { color: #667eea; font-size: 1.8rem; margin-bottom: 10px; font-weight: 800; }
    .control-panel p { color: #666; margin-bottom: 30px; font-size: 0.95rem; }
    .form-group { margin-bottom: 25px; }
    .form-group label {
      display: block; color: #333; font-weight: 700; margin-bottom: 10px; font-size: 0.95rem;
    }
    .form-group input[type="date"], .form-group textarea, .form-group select, .form-group input[type="number"] {
      width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 10px;
      font-size: 1rem; font-family: inherit; transition: all 0.3s; background: #f9f9f9;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus, .form-group input[type="number"]:focus {
      outline: none; border-color: #667eea; background: white;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .upload-box {
      border: 3px dashed #667eea; border-radius: 15px; padding: 30px; text-align: center;
      cursor: pointer; transition: all 0.3s; background: #f0f4ff;
    }
    .upload-box:hover { background: #e6edff; border-color: #5568d3; transform: translateY(-2px); }
    .upload-box input { display: none; }
    .upload-icon { font-size: 3rem; margin-bottom: 10px; color: #667eea; }
    .upload-text { color: #667eea; font-weight: 600; font-size: 1rem; }
    .file-info { margin-top: 10px; font-size: 0.85rem; color: #666; }

    /* Download Buttons */
    .btn-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }
    .btn-section h3 {
      color: #333;
      font-size: 1.1rem;
      margin-bottom: 15px;
      font-weight: 700;
    }
    .btn-download {
      width: 100%; padding: 18px; border: none; border-radius: 12px; font-size: 1.1rem;
      font-weight: 700; cursor: pointer; transition: all 0.3s; margin-top: 15px;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .btn-english {
      background: linear-gradient(135deg, #eb4141 0%, #a50000 100%);
      color: white; box-shadow: 0 10px 30px rgba(171, 0, 0, 0.35);
    }
    .btn-bangla {
      background: linear-gradient(135deg, #ff9156 0%, #ff2b2b 100%);
      color: white; box-shadow: 0 10px 30px rgba(255, 58, 58, 0.4);
    }
    .btn-video {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }
    .btn-download:hover {
      transform: translateY(-3px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }
    .btn-download:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Preview Section */
    .preview-section { display: flex; flex-direction: column; gap: 40px; }
    .preview-container {
      background: white; border-radius: 20px; padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    .preview-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0;
    }
    .preview-header h2 { color: #333; font-size: 1.5rem; font-weight: 700; }
    .lang-badge {
      background: linear-gradient(135deg, #eb4141 0%, #a50000 100%);
      color: white; padding: 8px 20px; border-radius: 20px; font-size: 0.9rem; font-weight: 700;
    }
    .lang-badge.bangla {
      background: linear-gradient(135deg, #ff9156 0%, #ff2b2b 100%);
    }

    /* Banner Wrapper - Dynamic sizing based on platform */
    .banner-wrapper {
      margin: 0 auto; padding: 18px;
      background: #f7f7f7; border-radius: 22px; border: 12px solid #d32f2f;
      position: relative; overflow: hidden; box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
      transition: all 0.3s ease-in-out;
      display: flex; /* Use flex to center the banner */
      justify-content: center;
      align-items: center;
    }
    .banner {
      background: white; border-radius: 16px;
      overflow: hidden; border: 3px solid rgba(211, 47, 47, 0.6);
      display: flex; flex-direction: column;
      transition: all 0.3s ease-in-out;
      box-sizing: content-box; /* Important for padding calculations */
    }

    /* Top Strip */
    .top-strip {
      background: linear-gradient(90deg, rgba(211,47,47,1) 0%, rgba(166,0,0,1) 100%);
      color: white; padding: 18px 28px; display: flex; justify-content: space-between;
      align-items: center; position: relative; z-index: 2;
    }
    .brand-area {
      display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 1.25rem;
      text-transform: uppercase; letter-spacing: 1px;
    }
    .brand-logo {
      max-width: 110px; max-height: 48px; filter: brightness(0.85); opacity: 0.9;
    }
    .date-badge {
      background: rgba(255,255,255,0.18); padding: 8px 18px; border-radius: 30px;
      font-weight: 700; font-size: 0.9rem; letter-spacing: 0.5px;
      border: 1px solid rgba(255,255,255,0.3);
    }

    /* Image Panel */
    .image-panel {
      position: relative;
      flex-grow: 1; /* Allow it to take available space */
      margin: 0 28px;
      margin-top: 15px;
      border-radius: 14px;
      overflow: hidden;
      border: 6px solid rgba(211, 47, 47, 0.85);
      box-shadow: 0 12px 28px rgba(0,0,0,0.25);
      display: flex; /* To ensure image covers the panel */
      justify-content: center;
      align-items: center;
    }
    .image-panel img {
      width: 100%; height: 100%; object-fit: cover; /* Cover the panel */
      filter: brightness(1.05) contrast(1.1) saturate(1.05);
    }
    .image-overlay {
      position: absolute; inset: 0; background: linear-gradient(180deg, rgba(0,0,0,0.25) 0%, rgba(0,0,0,0.6) 100%);
    }

    /* Headline Area */
    .headline-area {
      margin: 15px 28px 10px;
      padding: 18px 22px; background: #fff;
      border-radius: 12px; border: 1px solid rgba(211, 47, 47, 0.35);
      box-shadow: 0 10px 18px rgba(0, 0, 0, 0.1);
      display: flex; /* To center text if it's short */
      justify-content: center;
      align-items: center;      text-align: center; /* Center align text */
      word-break: break-word; /* Prevent long words from breaking layout */
    }
    .headline-text {
      color: #c80000;      font-size: 1.5rem; font-weight: 800; line-height: 1.4;
      width: 100%; /* Ensure it takes full width */
    }    /* CTA Ribbon */
    .cta-ribbon {
      margin: 0 28px 15px;
      padding: 14px 26px;
      background: linear-gradient(90deg, rgba(211,47,47,1) 0%, rgba(166,0,0,1) 100%);
      color: white; font-weight: 800; text-transform: uppercase;
      letter-spacing: 1px; border-radius: 12px; text-align: center;
      box-shadow: 0 8px 20px rgba(211,47,47,0.45);
      transition: all 0.3s ease-in-out;
    }
    .cta-ribbon.hidden {
      display: none;
    }

    /* Footer Bar */
    .footer-bar {
      background: #222; padding: 16px 15px;
      display: flex; justify-content: center; align-items: center; gap: 18px;
      border-top: 3px solid rgba(211, 47, 47, 0.8);
      flex-wrap: wrap;
    }
    .social-item {
      display: flex; align-items: center; gap: 6px;
      font-size: 0.9rem;
      font-weight: 700; color: white;
    }
    .social-icon {
      width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-size: 0.9rem; font-weight: 700; color: #fff;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .icon-facebook { background: #1877F2; }
    .icon-twitter { background: #000; }
    .icon-youtube { background: #FF0000; }
    .icon-instagram {
      background: linear-gradient(45deg,#f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);
    }

    .bangla-text { font-family: 'Noto Sans Bengali', sans-serif; }

    /* Progress indicator */
    .progress-indicator {
      margin-top: 15px;
      padding: 12px;
      background: #f0f4ff;
      border-radius: 8px;
      text-align: center;
      font-size: 0.9rem;
      color: #667eea;
      font-weight: 600;
      display: none;
    }    .progress-indicator.active {
      display: block;
    }

    /* Dynamic Aspect Ratio Classes */
    .banner-wrapper.aspect-ratio-16-9 { width: 715px; height: 402px; }
    .banner-wrapper.aspect-ratio-1-1 { width: 715px; height: 715px; }
    .banner-wrapper.aspect-ratio-4-5 { width: 715px; height: 894px; }
    .banner-wrapper.aspect-ratio-9-16 { width: 715px; height: 1269px; }

    @media (max-width: 1200px) {
      .main-container { grid-template-columns: 1fr; }
      .control-panel { position: static; max-height: none; }
      .banner-wrapper.aspect-ratio-16-9,
      .banner-wrapper.aspect-ratio-1-1,
      .banner-wrapper.aspect-ratio-4-5,
      .banner-wrapper.aspect-ratio-9-16 {
        width: 100%; /* Make responsive on smaller screens */
        max-width: 715px; /* Keep a reasonable max width */
        height: auto; /* Let height adjust */
      }
    }
  </style>
</head>
<body>

<div class="main-container">
  <!-- CONTROL PANEL -->
  <div class="control-panel">
    <h1>🎬 InfoMela Video Studio</h1>
    <p>Create banners & videos for all platforms</p>

    <div class="form-group">
      <label>📅 Date</label>
      <input type="date" id="bannerDate">
    </div>

    <div class="form-group">
      <label>🎥 Platform & Ratio</label>
      <select id="platformSelect">
        <option value="fb-square">Facebook - Square (1:1)</option>
        <option value="fb-landscape">Facebook - Landscape (16:9)</option>
        <option value="fb-portrait">Facebook - Portrait (4:5)</option>
        <option value="twitter-landscape">Twitter/X - Landscape (16:9)</option>
        <option value="twitter-square">Twitter/X - Square (1:1)</option>
        <option value="ig-feed">Instagram - Feed (1:1)</option>
        <option value="ig-portrait">Instagram - Portrait (4:5)</option>
        <option value="ig-story">Instagram - Story/Reel (9:16)</option>
        <option value="youtube">YouTube - Standard (16:9)</option>
      </select>
    </div>

    <div class="form-group">
      <label>⏱️ Video Duration (Seconds)</label>
      <input type="number" id="videoDuration" value="30" min="5" max="60">
    </div>

    <div class="form-group">
      <label>🖼️ Logo Upload</label>
      <div class="upload-box" onclick="document.getElementById('logoInput').click()">
        <input type="file" id="logoInput" accept="image/*">
        <div class="upload-icon">📷</div>
        <div class="upload-text">Click to upload logo</div>
        <div class="file-info" id="logoInfo">PNG or SVG recommended</div>
      </div>
    </div>

    <div class="form-group">
      <label>📸 Headline Image</label>
      <div class="upload-box" onclick="document.getElementById('imageInput').click()">
        <input type="file" id="imageInput" accept="image/*">
        <div class="upload-icon">🖼️</div>
        <div class="upload-text">Click to upload image</div>
        <div class="file-info" id="imageInfo">Auto enhanced & upscaled</div>
      </div>
    </div>

    <div class="form-group">
      <label>✍️ English Headline</label>
      <textarea id="captionEN">HASINA BUILT A MOSQUE IN DHAKA; WHAT WOULD BNP DO?</textarea>
    </div>

    <div class="form-group">
      <label>✍️ বাংলা শিরোনাম</label>
      <textarea id="captionBN" class="bangla-text">হাসিনা সৌদি ফেরত ঢাকায় মসজিদ তৈরি করেছে; বিএনপি ক্ষমতায় গেলে মন্দির তৈরি করবে?</textarea>
    </div>

    <!-- IMAGE DOWNLOADS -->
    <div class="btn-section">
      <h3>📥 Download Static Images</h3>
      <button class="btn-download btn-english" onclick="downloadBanner('english', 'image')">
        Download English Image
      </button>
      <button class="btn-download btn-bangla" onclick="downloadBanner('bangla', 'image')">
        বাংলা ছবি ডাউনলোড করুন
      </button>
    </div>

    <!-- VIDEO DOWNLOADS -->
    <div class="btn-section">
      <h3>🎬 Download Videos</h3>
      <button class="btn-download btn-video" id="btnVideoEN" onclick="downloadBanner('english', 'video')">
        🎥 Download English Video
      </button>
      <button class="btn-download btn-video" id="btnVideoBN" onclick="downloadBanner('bangla', 'video')">
        🎥 বাংলা ভিডিও ডাউনলোড করুন
      </button>
      <div class="progress-indicator" id="progressIndicator">
        Generating video... Please wait ⏳
      </div>
    </div>
  </div>

  <!-- PREVIEW SECTION -->
  <div class="preview-section">
    <!-- ENGLISH PREVIEW -->
    <div class="preview-container">
      <div class="preview-header">
        <h2>English Preview</h2>
        <span class="lang-badge">ENGLISH</span>
      </div>
      <div class="banner-wrapper" id="frameEN" data-ratio="16:9">
        <div class="banner" id="bannerEN">
          <div class="top-strip">
            <div class="brand-area">
              <img class="brand-logo" id="logoEN" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='48' viewBox='0 0 200 80'%3E%3Crect fill='%23ffffff' width='200' height='80' rx='10'/%3E%3Ctext x='100' y='50' font-family='Arial' font-size='32' font-weight='bold' fill='%23d32f2f' text-anchor='middle'%3EInfoMela%3C/text%3E%3C/svg%3E" alt="Logo">
              <span>News.Fun.Facts</span>
            </div>            <div class="date-badge" id="dateEN">14 OCTOBER 2025</div>
          </div>

          <div class="image-panel">
            <img id="bgImageEN" src="https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&w=1500&q=80" alt="Headline">
            <div class="image-overlay"></div>
          </div>

          <div class="headline-area">
            <div class="headline-text" id="captionDisplayEN">
              HASINA BUILT A MOSQUE IN DHAKA; WHAT WOULD BNP DO?
            </div>
          </div>

          <div class="cta-ribbon" id="ctaEN">DETAILS IN COMMENTS</div>

          <div class="footer-bar">
            <div class="social-item">
              <div class="social-icon icon-facebook">f</div>
              <span>@theinfomelaa</span>
            </div>
            <div class="social-item">
              <div class="social-icon icon-twitter">𝕏</div>
              <span>@theinfomela</span>
            </div>
            <div class="social-item">
              <div class="social-icon icon-youtube">▶</div>
              <span>@theinfomela</span>
            </div>
            <div class="social-item">
              <div class="social-icon icon-instagram">⧉</div>
              <span>@theinfomela</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BANGLA PREVIEW -->
    <div class="preview-container">
      <div class="preview-header">        <h2>বাংলা প্রিভিউ</h2>
        <span class="lang-badge bangla">বাংলা</span>
      </div>
      <div class="banner-wrapper" id="frameBN" data-ratio="16:9">        <div class="banner" id="bannerBN">
          <div class="top-strip">
            <div class="brand-area bangla-text">
              <img class="brand-logo" id="logoBN" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='48' viewBox='0 0 200 80'%3E%3Crect fill='%23ffffff' width='200' height='80' rx='10'/%3E%3Ctext x='100' y='50' font-family='Arial' font-size='32' font-weight='bold' fill='%23d32f2f' text-anchor='middle'%3Eইনফো মেলা%3C/text%3E%3C/svg%3E" alt="Logo">
              <span>খবর.মজা.তথ্য</span>
            </div>
            <div class="date-badge bangla-text" id="dateBN">১৪ অক্টোবর ২০২৫</div>
          </div>

          <div class="image-panel">
            <img id="bgImageBN" src="https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&w=1500&q=80" alt="Headline">
            <div class="image-overlay"></div>
          </div>

          <div class="headline-area bangla-text">
            <div class="headline-text bangla-text" id="captionDisplayBN">
              হাসিনা সৌদি ফেরত ঢাকায় মসজিদ তৈরি করেছে; বিএনপি ক্ষমতায় গেলে মন্দির তৈরি করবে?
            </div>
          </div>

          <div class="cta-ribbon bangla-text" id="ctaBN">বিস্তারিত কমেন্টে</div>

          <div class="footer-bar">
            <div class="social-item">
              <div class="social-icon icon-facebook">f</div>
              <span>@theinfomelaa</span>
            </div>
            <div class="social-item">
              <div class="social-icon icon-twitter">𝕏</div>
              <span>@theinfomela</span>
            </div>
            <div class="social-item">
              <div class="social-icon icon-youtube">▶</div>
              <span>@theinfomela</span>
            </div>
            <div class="social-item">
              <div class="social-icon icon-instagram">⧉</div>
              <span>@theinfomela</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Platform aspect ratios (width:height)
  const PLATFORM_RATIOS = {    'fb-square': { width: 1, height: 1 },
    'fb-landscape': { width: 16, height: 9 },
    'fb-portrait': { width: 4, height: 5 },
    'twitter-landscape': { width: 16, height: 9 },
    'twitter-square': { width: 1, height: 1 },
    'ig-feed': { width: 1, height: 1 },
    'ig-portrait': { width: 4, height: 5 },
    'ig-story': { width: 9, height: 16 },
    'youtube': { width: 16, height: 9 }
  };

  let currentImageHeight = 0; // To store the calculated height of the image panel

  document.addEventListener('DOMContentLoaded', () => {    const today = new Date();
    document.getElementById('bannerDate').value = today.toISOString().split('T')[0];
    updateDate();
    
    document.getElementById('bannerDate').addEventListener('change', updateDate);
    document.getElementById('platformSelect').addEventListener('change', updatePlatformRatio);
    document.getElementById('logoInput').addEventListener('change', handleLogoUpload);
    document.getElementById('imageInput').addEventListener('change', handleImageUpload);
    document.getElementById('captionEN').addEventListener('input', updateCaptions);
    document.getElementById('captionBN').addEventListener('input', updateCaptions);
    document.getElementById('videoDuration').addEventListener('change', updateProgressIndicator);

    updateCaptions();
    updatePlatformRatio();
    updateProgressIndicator();
  });

  function updateProgressIndicator() {
    const duration = parseInt(document.getElementById('videoDuration').value, 10) || 30;
    const progressText = `Generating video... (~${duration}s) ⏳`;
    document.getElementById('progressIndicator').textContent = progressText;  }

  function updatePlatformRatio() {
    const platform = document.getElementById('platformSelect').value;
    const ratio = PLATFORM_RATIOS[platform];
    
    document.querySelectorAll('.banner-wrapper').forEach(wrapper => {
      wrapper.setAttribute('data-ratio', `${ratio.width}:${ratio.height}`);
      applyAspectRatio(wrapper, ratio.width, ratio.height);
    });
    
    // Recalculate frame size after ratio change
    adjustFrameForContent();
  }

  function applyAspectRatio(element, widthRatio, heightRatio) {
    const displayScale = 715; // Base display width for previews
    const aspectRatio = heightRatio / widthRatio;
    const displayHeight = Math.round(aspectRatio * displayScale);
    element.style.width = `${displayScale}px`;
    element.style.height = `${displayHeight}px`;
  }

  function adjustFrameForContent() {
    const previewWrappers = document.querySelectorAll('.banner-wrapper');
    
    previewWrappers.forEach(wrapper => {
      const banner = wrapper.querySelector('.banner');
      const captionDisplayEN = document.getElementById('captionDisplayEN');
      const captionDisplayBN = document.getElementById('captionDisplayBN');
      const imagePanel = wrapper.querySelector('.image-panel');

      // Temporarily set banner to a large size to measure content
      banner.style.width = '2000px'; // Arbitrary large width
      banner.style.height = 'auto';
      banner.style.position = 'absolute'; // Remove from flow for measurement
      banner.style.visibility = 'hidden'; // Hide while measuring

      // Measure caption height
      const captionHeightEN = captionDisplayEN.offsetHeight;
      const captionHeightBN = captionDisplayBN.offsetHeight;
      const maxCaptionHeight = Math.max(captionHeightEN, captionHeightBN);

      // Measure image panel height (if image is loaded)
      const imgElement = imagePanel.querySelector('img');
      let imageHeight = 0;
      if (imgElement && imgElement.complete && imgElement.naturalHeight) {
          imageHeight = imgElement.naturalHeight;
      } else {
          imageHeight = 400; // Default height if image not loaded yet
      }

      // Calculate required banner height
      // Estimate heights of other elements (can be refined)
      const topStripHeight = 80; // Approximate height
      const headlineAreaPadding = 40; // Approximate padding
      const ctaRibbonHeight = 60; // Approximate height
      const footerBarHeight = 60; // Approximate height
      const imagePanelMarginTop = 15;
      const headlineAreaMarginTop = 15;
      const ctaRibbonMarginBottom = 15;

      let requiredBannerHeight = topStripHeight + imageHeight + headlineAreaPadding + maxCaptionHeight + ctaRibbonHeight + footerBarHeight + imagePanelMarginTop + headlineAreaMarginTop + ctaRibbonMarginBottom;
      
      // Ensure minimum height based on image panel
      const minBannerHeight = topStripHeight + imageHeight + topStripHeight; // At least image + top/bottom padding
      requiredBannerHeight = Math.max(requiredBannerHeight, minBannerHeight);

      // Get target aspect ratio from wrapper's data-ratio attribute
      const ratioParts = wrapper.getAttribute('data-ratio').split(':');
      const targetWidthRatio = parseInt(ratioParts[0], 10);
      const targetHeightRatio = parseInt(ratioParts[1], 10);
      const targetAspectRatio = targetHeightRatio / targetWidthRatio;

      let finalBannerWidth = 2000; // Start with max possible width
      let finalBannerHeight = requiredBannerHeight;

      // Adjust width and height to maintain target aspect ratio if possible,
      // but prioritize fitting content without overflow.
      // If required height dictates a different aspect ratio, we allow it.
      const calculatedAspectRatio = finalBannerHeight / finalBannerWidth;

      if (calculatedAspectRatio > targetAspectRatio) {
          // If content is taller than target ratio, adjust width to fit height
          finalBannerWidth = Math.round(finalBannerHeight / targetAspectRatio);
      } else {          // If content is wider than target ratio, adjust height to fit width
          finalBannerHeight = Math.round(finalBannerWidth * targetAspectRatio);
      }
      
      // Clamp to a reasonable maximum width to prevent extreme stretching
      const MAX_PREVIEW_WIDTH = 900; 
      if (finalBannerWidth > MAX_PREVIEW_WIDTH) {
          finalBannerWidth = MAX_PREVIEW_WIDTH;
          finalBannerHeight = Math.round(finalBannerWidth * targetAspectRatio);
      }

      // Ensure minimum content visibility
      const MIN_BANNER_HEIGHT = 600; // Minimum height for banner content
      if (finalBannerHeight < MIN_BANNER_HEIGHT) {
          finalBannerHeight = MIN_BANNER_HEIGHT;
          finalBannerWidth = Math.round(finalBannerHeight * targetAspectRatio);
      }

      // Apply calculated dimensions back to the banner
      banner.style.width = `${finalBannerWidth}px`;
      banner.style.height = `${finalBannerHeight}px`;
      banner.style.position = 'relative'; // Restore to normal flow
      banner.style.visibility = 'visible'; // Make visible

      // Adjust wrapper size to center the banner
      const wrapperScaleFactor = parseFloat(wrapper.style.width) / finalBannerWidth; // How much the wrapper is scaled down
      const scaledBannerHeight = finalBannerHeight * wrapperScaleFactor;
      wrapper.style.height = `${scaledBannerHeight}px`;
      
      // Ensure image panel within the banner has correct height for content
      const bannerImagePanel = banner.querySelector('.image-panel');
      if (bannerImagePanel) {
          const bannerImage = bannerImagePanel.querySelector('img');
          if (bannerImage) {
              bannerImage.style.objectFit = 'cover'; // Maintain cover for image
          }
      }
    });
  }

  function updateDate() {
    const dateStr = document.getElementById('bannerDate').value;
    if (!dateStr) return;
    const date = new Date(dateStr + 'T00:00:00');

    const optionsEN = { year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('dateEN').textContent = date.toLocaleDateString('en-GB', optionsEN).toUpperCase();

    const monthsBN = ['জানুয়ারি','ফেব্রুয়ারি','মার্চ','এপ্রিল','মে','জুন','জুলাই','আগস্ট','সেপ্টেম্বর','অক্টোবর','নভেম্বর','ডিসেম্বর'];
    const bnDay = date.getDate();
    const bnMonth = monthsBN[date.getMonth()];
    const bnYear = date.getFullYear();
    document.getElementById('dateBN').textContent = `${bnDay} ${bnMonth} ${bnYear}`;
  }

  function updateCaptions() {
    document.getElementById('captionDisplayEN').textContent = document.getElementById('captionEN').value;
    document.getElementById('captionDisplayBN').textContent = document.getElementById('captionBN').value;
    adjustFrameForContent(); // Adjust frame when captions change
  }

  function handleLogoUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('logoInfo').textContent = file.name;

    const reader = new FileReader();    reader.onload = (event) => {
      document.getElementById('logoEN').src = event.target.result;
      document.getElementById('logoBN').src = event.target.result;
      extractDominantColor(event.target.result);
    };
    reader.readAsDataURL(file);
  }

  function extractDominantColor(src) {
    const img = new Image();
    img.crossOrigin = 'Anonymous';
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

      let r = 0, g = 0, b = 0, count = 0;
      for (let i = 0; i < data.length; i += 4) {
        // Consider pixels that are not fully transparent        if (data[i+3] > 120) {
          r += data[i];
          g += data[i + 1];
          b += data[i + 2];
          count++;
        }
      }
      if (count === 0) return; // No visible pixels found

      r = Math.round(r / count);
      g = Math.round(g / count);
      b = Math.round(b / count);
      const hex = '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
      applyBrandColor(hex);
    };
    img.onerror = function() {
        console.error("Failed to load image for color extraction.");
    };
    img.src = src;
  }

  function applyBrandColor(color) {
    const frameWrappers = document.querySelectorAll('.banner-wrapper');
    frameWrappers.forEach(frame => {
      frame.style.borderColor = color;
    });

    const elementsToTint = [
      { selector: '.banner', prop: 'borderColor', color: shadeColor(color, -20), opacity: 0.6 },
      { selector: '.top-strip', prop: 'background', gradient: true, color1: color, color2: shadeColor(color, -40) },
      { selector: '.cta-ribbon', prop: 'background', gradient: true, color1: color, color2: shadeColor(color, -40) },
      { selector: '.image-panel', prop: 'borderColor', color: shadeColor(color, -20), opacity: 0.85 },
      { selector: '.headline-area', prop: 'borderColor', color: color, opacity: 0.35 },
      { selector: '.footer-bar', prop: 'borderTopColor', color: color, opacity: 0.8 }
    ];

    elementsToTint.forEach(item => {
      document.querySelectorAll(item.selector).forEach(el => {
        if (item.gradient) {
          el.style[item.prop] = `linear-gradient(90deg, ${item.color1} 0%, ${item.color2} 100%)`;
        } else {
          let finalColor = item.color || color;
          if (item.opacity) {
            const rgba = hexToRgba(finalColor, item.opacity);
            el.style[item.prop] = rgba;
          } else {
            el.style[item.prop] = finalColor;
          }
        }
      });
    });

    document.querySelectorAll('.headline-text').forEach(el => {
      el.style.color = shadeColor(color, -10);
    });
  }

  function shadeColor(color, percent) {
    let R = parseInt(color.substring(1, 3), 16);
    let G = parseInt(color.substring(3, 5), 16);
    let B = parseInt(color.substring(5, 7), 16);

    R = parseInt(R * (1 + percent/100));
    G = parseInt(G * (1 + percent/100));
    B = parseInt(B * (1 + percent/100));

    R = (R<255)?R:255; G = (G<255)?G:255; B = (B<255)?B:255;
    R = (R>0)?R:0; G = (G>0)?G:0; B = (B>0)?B:0;

    const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
    const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
    const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

    return "#"+RR+GG+BB;
  }

  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }

  function handleImageUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('imageInfo').textContent = file.name;

    const reader = new FileReader();
    reader.onload = (event) => {
      const img = new Image();
      img.onload =() => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        // Apply enhancements
        ctx.filter = 'brightness(1.08) contrast(1.1) saturate(1.08)';
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0, img.width, img.height);
        const enhanced = canvas.toDataURL('image/jpeg', 0.98);
        
        document.getElementById('bgImageEN').src = enhanced;
        document.getElementById('bgImageBN').src = enhanced;
        
        // Update frame size after image is loaded and potentially enhanced
        adjustFrameForContent();
      };
      img.onerror = function() {
          alert("Error loading image.");
      };
      img.src = event.target.result;
    };
    reader.readAsDataURL(file);
  }

  async function downloadBanner(lang, type) {
    const bannerId = lang === 'english' ? 'bannerEN' : 'bannerBN';    const ctaId = lang === 'english' ? 'ctaEN' : 'ctaBN';
    const platform = document.getElementById('platformSelect').value;
    const ratio = PLATFORM_RATIOS[platform];

    // Hide CTA ribbon for video generation
    const ctaElement = document.getElementById(ctaId);
    const originalDisplay = ctaElement.style.display;
    if (type === 'video') {
      ctaElement.classList.add('hidden');
    }

    // Ensure frame is adjusted before capturing
    adjustFrameForContent();

    // Wait a moment for adjustments to apply
    await new Promise(resolve => setTimeout(resolve, 100));

    const bannerElement = document.getElementById(bannerId);
    const computedStyle = window.getComputedStyle(bannerElement);
    const bannerWidth = parseFloat(computedStyle.width);
    const bannerHeight = parseFloat(computedStyle.height);
    
    const renderScale = type === 'video' ? 2 : 3; // Higher scale for video for better quality
    const finalWidth = bannerWidth / renderScale;
    const finalHeight = bannerHeight / renderScale;

    if (type === 'image') {
      await downloadImage(bannerElement, lang, finalWidth, finalHeight, renderScale);
    } else {
      await downloadVideo(bannerElement, lang, finalWidth, finalHeight, renderScale);
    }

    // Restore CTA ribbon
    if (type === 'video') {
      ctaElement.classList.remove('hidden');
    }
  }

  async function downloadImage(bannerElement, lang, width, height, scale) {
    if (typeof html2canvas === 'undefined') {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    }

    html2canvas(bannerElement, {
      scale: scale,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff',
      width: width,
      height: height,
      logging: false
    }).then(canvas => {
      const link = document.createElement('a');
      link.download = `InfoMela_${lang}_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png', 1.0);
      link.click();
    }).catch(err => {
        console.error("HTML2Canvas error for image download:", err);
        alert("Failed to download image. Please check console for details.");
    });
  }

  async function downloadVideo(bannerElement, lang, width, height, scale) {
    const progressIndicator = document.getElementById('progressIndicator');
    const btnEN = document.getElementById('btnVideoEN');
    const btnBN = document.getElementById('btnVideoBN');    const videoDurationInput = document.getElementById('videoDuration');
    const duration = parseInt(videoDurationInput.value, 10) * 1000 || 30000; // in milliseconds

    // Disable buttons and show progress
    btnEN.disabled = true;
    btnBN.disabled = true;
    progressIndicator.classList.add('active');
    progressIndicator.textContent = `Generating video... (~${duration/1000}s) ⏳`;

    try {
      if (typeof html2canvas === 'undefined') {
        await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
      }

      // Render to canvas
      const canvas = await html2canvas(bannerElement, {
        scale: scale,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        width: width,
        height: height,
        logging: false
      });

      // Create video from canvas stream
      const stream = canvas.captureStream(30); // 30 FPS
      const mediaRecorder = new MediaRecorder(stream, {
        mimeType: 'video/webm;codecs=vp9', // VP9 for better quality and compatibility
        videoBitsPerSecond: 5000000 // 5 Mbps for high quality
      });

      const chunks = [];
      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) {
          chunks.push(e.data);
        }
      };

      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `InfoMela_${lang}_video_${Date.now()}.webm`;
        link.click();
        URL.revokeObjectURL(url);

        // Re-enable buttons
        btnEN.disabled = false;
        btnBN.disabled = false;
        progressIndicator.classList.remove('active');
      };

      mediaRecorder.start();
      
      // Record for the specified duration
      setTimeout(() => {
        mediaRecorder.stop();
      }, duration); // Use the duration from input

    } catch (error) {
      console.error('Video generation failed:', error);
      alert('Video generation failed. Please try again. Check console for details.');
      btnEN.disabled = false;
      btnBN.disabled = false;
      progressIndicator.classList.remove('active');
    }
  }

  function loadScript(src) {
    return new Promise((resolve, reject) => {
      // Check if script is already loaded
      if (document.querySelector(`script[src="${src}"]`)) {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = src;
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }
</script>
</body>
</html>
