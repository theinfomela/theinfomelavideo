<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enhanced InfoMela Studio ‚Äî Fixed Version</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Noto+Sans+Bengali:wght@600;700&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 30px;
      color: #fff;
    }
    .main-container {
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 400px 1fr;
      gap: 40px;
    }
    .control-panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 35px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 30px;
      max-height: 95vh;
      overflow-y: auto;
    }
    .control-panel h1 { color: #667eea; font-size: 1.8rem; font-weight: 800; margin-bottom: 12px; }
    .control-panel p { color: #555; margin-bottom: 30px; }
    .form-group { margin-bottom: 25px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-family: inherit;
    }
    .form-group textarea { resize: vertical; }
    .upload-box {
      border: 3px dashed #667eea; border-radius: 15px; padding: 20px; text-align: center;
      background: #f0f4ff; cursor: pointer; transition: 0.3s;
    }
    .upload-box:hover { background: #e6edff; }
    .upload-icon { font-size: 2rem; color: #667eea; }
    .file-info { font-size: 0.85rem; color: #555; margin-top: 10px; }
    .btn-download {
      width: 100%; padding: 15px; border: none; border-radius: 12px;
      font-weight: 700; cursor: pointer; transition: all 0.3s; color: #fff; margin-top: 10px;
    }
    .btn-english { background: linear-gradient(135deg, #eb4141, #a50000); }
    .btn-bangla { background: linear-gradient(135deg, #ff9156, #ff2b2b); }
    .btn-video { background: linear-gradient(135deg, #667eea, #764ba2); }
    .btn-download:hover { transform: translateY(-3px); }
    .preview-section { display: flex; flex-direction: column; gap: 40px; }
    .preview-container {
      background: #fff; border-radius: 20px; color: #000; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 30px;
    }
    .banner-wrapper { margin: auto; width: 720px; background: #f7f7f7; padding: 15px; border-radius: 18px; border: 10px solid #d32f2f; }
    .banner { position: relative; background: #fff; border-radius: 14px; overflow: hidden; }
    .top-strip { background: linear-gradient(90deg,#d32f2f,#a50000); color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
    .brand-area { display:flex; gap:10px; align-items:center; font-weight:800;}
    .brand-logo { width:100px; height:auto; }
    .image-panel{margin:15px;border:5px solid rgba(211,47,47,.8);border-radius:12px;overflow:hidden;background:#000;}
    .image-panel img{width:100%;height:100%;object-fit:contain;}
    .headline-area{margin:15px;padding:15px;background:#fff;border-radius:10px;border:2px solid rgba(211,47,47,.4);}
    .headline-text{color:#c80000;font-weight:800;line-height:1.4;}
    .cta-ribbon{margin:20px;background:linear-gradient(90deg,#d32f2f,#a50000);color:#fff;text-align:center;padding:10px;font-weight:700;border-radius:10px;}
    .footer-bar{background:#222;color:#fff;display:flex;justify-content:center;gap:15px;padding:10px;border-top:3px solid #d32f2f;}
    .progress-indicator{margin-top:10px;color:#667eea;font-weight:600;}
  </style>
</head>

<body>
<div class="main-container">
  <div class="control-panel">
    <h1>üé¨ InfoMela Studio (Fixed)</h1>
    <p>Generate banners and 30‚Äì120s looping videos directly in Chrome!</p>

    <div class="form-group">
      <label>Date</label>
      <input type="date" id="bannerDate"/>
    </div>

    <div class="form-group">
      <label>Platform Ratio</label>
      <select id="platformSelect">
        <option value="fb-square">Facebook Square (1:1)</option>
        <option value="youtube">YouTube Landscape (16:9)</option>
        <option value="ig-story">Instagram Story (9:16)</option>
      </select>
    </div>

    <div class="form-group">
      <label>Logo Upload</label>
      <div class="upload-box" onclick="document.getElementById('logoInput').click()">
        <input type="file" id="logoInput" accept="image/*" style="display:none;"/>
        <div class="upload-icon">üì∑</div>
        <div class="file-info" id="logoInfo">PNG/SVG recommended</div>
      </div>
    </div>

    <div class="form-group">
      <label>Headline Image</label>
      <div class="upload-box" onclick="document.getElementById('imageInput').click()">
        <input type="file" id="imageInput" accept="image/*" style="display:none;"/>
        <div class="upload-icon">üñºÔ∏è</div>
        <div class="file-info" id="imageInfo">Click to upload</div>
      </div>
    </div>

    <div class="form-group">
      <label>English Headline</label>
      <textarea id="captionEN">HASINA BUILT A MOSQUE IN DHAKA; WHAT WOULD BNP DO?</textarea>
    </div>

    <div class="form-group">
      <label>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ</label>
      <textarea id="captionBN" class="bangla-text">‡¶π‡¶æ‡¶∏‡¶ø‡¶®‡¶æ ‡¶¢‡¶æ‡¶ï‡¶æ‡¶Ø‡¶º ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá; ‡¶¨‡¶ø‡¶è‡¶®‡¶™‡¶ø ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶¨‡ßá?</textarea>
    </div>

    <div class="form-group">
      <label>Video Duration (30‚Äì120s)</label>
      <input type="number" id="videoDuration" min="30" max="120" value="60"/>
    </div>
    <div class="form-group">
      <label>Zoom Intensity (0‚Äì30)</label>
      <input type="range" id="zoomEffect" min="0" max="30" step="1" value="8"/>
    </div>

    <div class="btn-download btn-english" onclick="downloadBanner('english','image')">Download English Image</div>
    <div class="btn-download btn-bangla" onclick="downloadBanner('bangla','image')">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶õ‡¶¨‡¶ø ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</div>
    <div class="btn-download btn-video" id="btnVideoEN" onclick="downloadBanner('english','video')">üé• Download English Video</div>
    <div class="btn-download btn-video" id="btnVideoBN" onclick="downloadBanner('bangla','video')">üé• ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</div>
    <div class="progress-indicator" id="progressIndicator"></div>
  </div>

  <!-- PREVIEW -->
  <div class="preview-section">
    <div class="preview-container">
      <h2>English Preview</h2>
      <div class="banner-wrapper">
        <div class="banner" id="bannerEN">
          <div class="top-strip"><div class="brand-area"><img id="logoEN" class="brand-logo" src="" alt="Logo"/><span>InfoMela</span></div><div id="dateEN"></div></div>
          <div class="image-panel"><img id="bgImageEN" src="" alt=""/></div>
          <div class="headline-area"><div id="captionDisplayEN" class="headline-text"></div></div>
          <div class="cta-ribbon" id="ctaEN">DETAILS BELOW</div>
          <div class="footer-bar">@theinfomela</div>
        </div>
      </div>
    </div>
    <div class="preview-container">
      <h2>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</h2>
      <div class="banner-wrapper">
        <div class="banner bangla-text" id="bannerBN">
          <div class="top-strip"><div class="brand-area"><img id="logoBN" class="brand-logo" src="" alt="Logo"/><span>‡¶á‡¶®‡¶´‡ßã ‡¶Æ‡ßá‡¶≤‡¶æ</span></div><div id="dateBN"></div></div>
          <div class="image-panel"><img id="bgImageBN" src="" alt=""/></div>
          <div class="headline-area"><div id="captionDisplayBN" class="headline-text"></div></div>
          <div class="cta-ribbon" id="ctaBN">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶®‡¶ø‡¶ö‡ßá</div>
          <div class="footer-bar">@theinfomela</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const PLATFORM_RATIOS = {
  'fb-square': { width:1080, height:1080 },
  'youtube': { width:1920, height:1080 },
  'ig-story': { width:1080, height:1920 }
};
const state = { backgroundColor:'#fff', logoURL:null, photoURL:null };
const videoConfig = { duration:60, fps:30, zoomEffect:8 };

document.addEventListener('DOMContentLoaded', () => {
  const today = new Date(); document.getElementById('bannerDate').value = today.toISOString().split('T')[0];
  updateDate(); updateCaptions();
  document.getElementById('bannerDate').addEventListener('change', updateDate);
  document.getElementById('captionEN').addEventListener('input', updateCaptions);
  document.getElementById('captionBN').addEventListener('input', updateCaptions);
  document.getElementById('logoInput').addEventListener('change', handleLogoUpload);
  document.getElementById('imageInput').addEventListener('change', handleImageUpload);
  document.getElementById('videoDuration').addEventListener('input', e => {
    videoConfig.duration = Math.min(120, Math.max(30, Number(e.target.value)));
  });
  document.getElementById('zoomEffect').addEventListener('input', e => {
    videoConfig.zoomEffect = Number(e.target.value);
  });
});

function updateDate() {
  const val = document.getElementById('bannerDate').value; if (!val) return;
  const date = new Date(val);
  document.getElementById('dateEN').textContent = date.toDateString().toUpperCase();
  document.getElementById('dateBN').textContent = `${date.getDate()} ‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞ ${date.getFullYear()}`;
}

function updateCaptions() {
  document.getElementById('captionDisplayEN').textContent = document.getElementById('captionEN').value;
  document.getElementById('captionDisplayBN').textContent = document.getElementById('captionBN').value;
}

function handleLogoUpload(e) {
  const file = e.target.files[0]; if (!file) return;
  state.logoURL = URL.createObjectURL(file);
  document.getElementById('logoInfo').textContent = file.name;
  document.getElementById('logoEN').src = state.logoURL;
  document.getElementById('logoBN').src = state.logoURL;
}

function handleImageUpload(e) {
  const file = e.target.files[0]; if (!file) return;
  state.photoURL = URL.createObjectURL(file);
  document.getElementById('imageInfo').textContent = file.name;
  document.getElementById('bgImageEN').src = state.photoURL;
  document.getElementById('bgImageBN').src = state.photoURL;
}

async function downloadBanner(lang, type) {
  const banner = document.getElementById(lang === 'english' ? 'bannerEN' : 'bannerBN');
  const ratio = PLATFORM_RATIOS[document.getElementById('platformSelect').value];
  if (type === 'image') await downloadImage(banner, lang, ratio); else await downloadVideo(banner, lang, ratio);
}

async function downloadImage(banner, lang, ratio) {
  try {
    banner.querySelectorAll('img').forEach(img => { if (img.src.startsWith('http')) img.crossOrigin = 'anonymous'; });
    const canvas = await html2canvas(banner, { scale: 2, backgroundColor: '#fff', useCORS: true });
    const final = document.createElement('canvas'); final.width = ratio.width; final.height = ratio.height;
    const ctx = final.getContext('2d'); ctx.drawImage(canvas, 0, 0, final.width, final.height);
    const link = document.createElement('a'); link.download = `InfoMela_${lang}_${Date.now()}.png`;
    link.href = final.toDataURL('image/png'); link.click();
  } catch (err) { console.error(err); alert('Image download failed. Use local uploads or same-origin images.'); }
}

async function downloadVideo(banner, lang, ratio) {
  const progress = document.getElementById('progressIndicator');
  const btnEN = document.getElementById('btnVideoEN'), btnBN = document.getElementById('btnVideoBN');
  btnEN.disabled = btnBN.disabled = true; progress.textContent = 'Rendering video...';

  try {
    const snapshot = await html2canvas(banner, { scale: 2, backgroundColor: '#fff', useCORS: true });
    const image = await canvasToImage(snapshot);

    const canvas = document.createElement('canvas'); canvas.width = ratio.width; canvas.height = ratio.height;
    const ctx = canvas.getContext('2d');

    const mime = MediaRecorder.isTypeSupported('video/webm;codecs=vp8') ? 'video/webm;codecs=vp8' : 'video/webm';
    const stream = canvas.captureStream(videoConfig.fps);
    const recorder = new MediaRecorder(stream, { mimeType: mime });
    const chunks = []; recorder.ondataavailable = e => e.data.size && chunks.push(e.data);

    const totalFrames = Math.floor(videoConfig.duration * videoConfig.fps); recorder.start();
    let frame = 0;

    function drawFrame() {
      const p = (frame % totalFrames) / totalFrames;
      drawAnimatedFrame(ctx, image, canvas.width, canvas.height, p);
      frame++;
      if (frame < totalFrames) setTimeout(drawFrame, 1000 / videoConfig.fps); else recorder.stop();
    }

    drawFrame();
    await new Promise(r => recorder.onstop = r);

    const blob = new Blob(chunks, { type: mime }); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `InfoMela_${lang}_${Date.now()}.webm`; a.click(); URL.revokeObjectURL(url);
  } catch (err) { console.error(err); alert('Video generation failed.'); }
  finally { btnEN.disabled = btnBN.disabled = false; progress.textContent = ''; }
}

function drawAnimatedFrame(ctx, img, w, h, p) {
  ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, w, h);
  const zoom = 1 + (Math.sin(p * Math.PI * 2) * (videoConfig.zoomEffect / 100));
  const offsetX = Math.sin(p * Math.PI * 4) * 20;
  const offsetY = Math.cos(p * Math.PI * 4) * 10;
  ctx.save(); ctx.translate(w / 2 + offsetX, h / 2 + offsetY); ctx.scale(zoom, zoom);
  ctx.drawImage(img, -w / 2, -h / 2, w, h); ctx.restore();
}

function canvasToImage(canvas) {
  return new Promise(res => { const img = new Image(); img.onload = () => res(img); img.src = canvas.toDataURL(); });
}
</script>

</body>
</html>
