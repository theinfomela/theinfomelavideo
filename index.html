<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Enhanced InfoMela Studio ‚Äì Reliable Output</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- --------------- FONTS ---------------- -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Noto+Sans+Bengali:wght@600;700&display=swap"
      rel="stylesheet">

<!-- --------------- MP4 MUXER (for WebCodecs) ---------------- -->
<script src="https://cdn.jsdelivr.net/npm/mp4-muxer@2.0.2/build/mp4-muxer.min.js"></script>

<!-- --------------- html2canvas (for image export) ---------------- -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
/* --------------------------------------------------------------
   BASIC LAYOUT ‚Äì kept identical to the version you posted,
   with a few tiny tweaks for higher‚Äëres image export.
   -------------------------------------------------------------- */
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  min-height:100vh;padding:30px;color:#fff
}
.main-container{max-width:1600px;margin:auto;display:grid;grid-template-columns:400px 1fr;gap:40px}
.control-panel{
  background:rgba(255,255,255,0.95);
  border-radius:20px;padding:35px;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
  position:sticky;top:30px;max-height:95vh;overflow-y:auto
}
.control-panel h1{color:#667eea;font-size:1.8rem;margin-bottom:10px;font-weight:800}
.control-panel p{color:#666;margin-bottom:30px;font-size:.95rem}
.form-group{margin-bottom:25px}
.form-group label{display:block;color:#333;font-weight:700;margin-bottom:10px;font-size:.95rem}
.form-group input,
.form-group textarea,
.form-group select{
  width:100%;padding:14px;border:2px solid #e0e0e0;border-radius:10px;font-size:1rem;
  background:#f9f9f9;transition:all .3s;font-family:inherit
}
.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus{
  outline:none;border-color:#667eea;background:white;
  box-shadow:0 0 0 4px rgba(102,126,234,.1)
}
.form-group textarea{min-height:80px;resize:vertical}
.upload-box{
  border:3px dashed #667eea;border-radius:15px;padding:30px;text-align:center;
  cursor:pointer;transition:all .3s;background:#f0f4ff;position:relative
}
.upload-box input{position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;cursor:pointer}
.upload-box:hover{background:#e6edff;border-color:#5568d3;transform:translateY(-2px)}
.upload-icon{font-size:3rem;margin-bottom:10px;color:#667eea}
.upload-text{color:#667eea;font-weight:600;font-size:1rem}
.file-info{margin-top:10px;font-size:.85rem;color:#666}
.video-options{background:#f0f4ff;border-radius:10px;padding:15px;margin-top:15px}
.video-options h4{color:#667eea;margin-bottom:12px;font-size:.95rem}
.option-row{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.option-row label{color:#333;font-weight:600;font-size:.9rem;min-width:140px}
.option-row input,
.option-row select{flex:1;padding:10px;border-radius:8px;border:1px solid #ccc}
.advanced-toggle{
  margin-top:22px;padding:12px 16px;border-radius:10px;background:#f0f4ff;
  display:flex;justify-content:space-between;align-items:center;
  cursor:pointer;transition:.3s
}
.advanced-toggle:hover{background:#e6edff}
.advanced-content{display:none;margin-top:16px}
.advanced-content.active{display:block}
.range-row{margin-bottom:14px}
.range-row label{display:block;margin-bottom:6px;font-weight:600;color:#333}
.range-row input[type=range]{width:100%}
.btn-section{margin-top:30px;padding-top:20px;border-top:2px solid #e0e0e0}
.btn-section h3{color:#333;font-size:1.1rem;margin-bottom:15px;font-weight:700}
.btn-download{
  width:100%;padding:18px;border:none;border-radius:12px;
  font-size:1.1rem;font-weight:700;cursor:pointer;
  transition:all .3s;margin-top:15px;text-transform:uppercase;letter-spacing:.5px
}
.btn-english{background:linear-gradient(135deg,#eb4141 0%,#a50000 100%);color:#fff;box-shadow:0 10px 30px rgba(171,0,0,.35)}
.btn-bangla{background:linear-gradient(135deg,#ff9156 0%,#ff2b2f 100%);color:#fff;box-shadow:0 10px 30px rgba(255,58,58,.4)}
.btn-video{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;box-shadow:0 10px 30px rgba(102,126,234,.4)}
.btn-download:hover{transform:translateY(-3px);box-shadow:0 15px 40px rgba(0,0,0,.3)}
.btn-download:disabled{opacity:.55;cursor:not-allowed;transform:none}
.progress-indicator{
  margin-top:15px;padding:12px;background:#f0f4ff;
  border-radius:8px;text-align:center;font-size:.9rem;color:#667eea;
  font-weight:600;display:none
}
.progress-indicator.active{display:block}
.preview-section{display:flex;flex-direction:column;gap:40px}
.preview-container{
  background:#fff;border-radius:20px;padding:30px;
  box-shadow:0 20px 60px rgba(0,0,0,.3);color:#000
}
.preview-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
.preview-header h2{color:#333;font-size:1.5rem;font-weight:700}
.lang-badge{
  background:linear-gradient(135deg,#eb4141 0%,#a50000 100%);
  color:#fff;padding:8px 20px;border-radius:20px;font-size:.9rem;font-weight:700
}
.lang-badge.bangla{background:linear-gradient(135deg,#ff9156 0%,#ff2b2f 100%)}
.banner-wrapper{
  margin:0 auto;padding:18px;background:#f7f7f7;
  border-radius:22px;border:12px solid #d32f2f;
  position:relative;overflow:hidden;
  box-shadow:0 25px 60px rgba(0,0,0,.35);
  transition:all .3s;width:100%;max-width:720px
}
.banner{
  width:100%;min-height:520px;position:relative;
  background:#fff;border-radius:16px;overflow:hidden;
  border:3px solid rgba(211,47,47,.6);
  display:flex;flex-direction:column
}
.top-strip{
  background:linear-gradient(90deg,#d32f2f 0%,#a50000 100%);
  color:#fff;padding:18px 28px;
  display:flex;justify-content:space-between;align-items:center;
  z-index:2
}
.brand-area{
  display:flex;align-items:center;gap:12px;
  font-weight:800;font-size:1.25rem;text-transform:uppercase;letter-spacing:1px
}
.brand-logo{
  max-width:110px;max-height:48px;
  filter:brightness(.92);opacity:.95
}
.slogan{font-size:.9rem;color:rgba(255,255,255,.9);font-weight:500}
.date-badge{
  background:rgba(255,255,255,.18);
  padding:8px 18px;border-radius:30px;
  font-weight:700;font-size:.9rem;letter-spacing:.5px;
  border:1px solid rgba(255,255,255,.3)
}
.image-panel{
  position:relative;flex-grow:1;margin:18px 28px;
  border-radius:14px;overflow:hidden;
  border:6px solid rgba(211,47,47,.85);
  box-shadow:0 12px 28px rgba(0,0,0,.25);
  background:#111;display:flex;align-items:center;justify-content:center
}
.image-panel img{width:100%;height:100%;object-fit:contain;background:#111}
.image-overlay{
  position:absolute;inset:0;pointer-events:none;
  background:linear-gradient(180deg,rgba(0,0,0,.12) 0%,rgba(0,0,0,.4) 100%)
}
.headline-area{
  margin:0 28px 18px;padding:22px 26px;
  background:#c80000;border-radius:12px;
  border:1px solid rgba(211,47,47,.35);
  box-shadow:0 10px 18px rgba(0,0,0,.1);
  display:flex;align-items:center;justify-content:center;
  min-height:90px
}
.headline-text{
  color:#fff;font-weight:900;line-height:1.5;
  word-wrap:break-word;overflow-wrap:break-word;
  transition:font-size .2s ease;font-family:inherit;
  text-align:center;letter-spacing:0.3px
}
.cta-ribbon{
  margin:0 28px 20px;padding:14px 26px;
  background:linear-gradient(90deg,rgba(211,47,47,1) 0%,rgba(166,0,0,1) 100%);
  color:#fff;font-weight:800;text-transform:uppercase;
  letter-spacing:1px;border-radius:12px;text-align:center;
  box-shadow:0 8px 20px rgba(211,47,47,.45)
}
.cta-ribbon.hidden{display:none}
.footer-bar{
  background:#222;padding:14px 10px;
  display:flex;justify-content:center;align-items:center;
  gap:12px;border-top:3px solid rgba(211,47,47,.8);
  flex-wrap:nowrap;margin-bottom:12px;
  overflow-x:auto
}
.social-item{
  display:flex;align-items:center;gap:4px;
  font-size:0.72rem;font-weight:700;color:#fff;
  white-space:nowrap;flex-shrink:0
}
.social-icon{
  width:24px;height:24px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:.8rem;font-weight:700;color:#fff;
  box-shadow:0 4px 8px rgba(0,0,0,.3);flex-shrink:0
}
.icon-facebook{background:#1877F2}
.icon-twitter{background:#000}
.icon-youtube{background:#FF0000}
.icon-instagram{
  background:linear-gradient(45deg,#f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%)
}
.bangla-text{font-family:'Noto Sans Bengali',sans-serif}
.memory-indicator{
  background:#fff3cd;color:#856404;padding:10px;border-radius:8px;
  margin-top:15px;font-size:0.85rem;text-align:center;display:none
}
.video-processing-hint{
  background:#d4edda;color:#155724;padding:12px;border-radius:8px;
  margin-top:15px;font-size:0.85rem
}
.quality-selector{
  margin-top:15px;padding:12px;background:#f0f4ff;border-radius:8px
}
.quality-selector label{display:block;margin-bottom:5px;font-weight:600}
.processing-controls{display:flex;gap:10px;margin-top:15px}
.btn-control{
  flex:1;padding:10px;border:none;border-radius:8px;background:#e0e0e0;cursor:pointer;transition:all .2s
}
.btn-control:hover{background:#d0d0d0}
@media(max-width:1200px){
  .main-container{grid-template-columns:1fr}
  .control-panel{position:static;max-height:none}
}
</style>
</head>

<body>
<div class="main-container">

  <!-- ==================== CONTROL PANEL ==================== -->
  <div class="control-panel">
    <h1>üé¨ Enhanced InfoMela Studio</h1>
    <p>Generate high‚Äëquality images and videos that always work</p>

    <!-- DATE -->
    <div class="form-group">
      <label>üìÖ Date</label>
      <input type="date" id="bannerDate">
    </div>

    <!-- PLATFORM -->
    <div class="form-group">
      <label>üé• Platform Ratio</label>
      <select id="platformSelect">
        <option value="fb-square">Facebook ‚Äì Square (1:1)</option>
        <option value="fb-landscape">Facebook ‚Äì Landscape (16:9)</option>
        <option value="fb-portrait">Facebook ‚Äì Portrait (4:5)</option>
        <option value="twitter-landscape">Twitter/X ‚Äì Landscape (16:9)</option>
        <option value="twitter-square">Twitter/X ‚Äì Square (1:1)</option>
        <option value="ig-feed">Instagram ‚Äì Feed (1:1)</option>
        <option value="ig-portrait">Instagram ‚Äì Portrait (4:5)</option>
        <option value="ig-story">Instagram ‚Äì Story/Reel (9:16)</option>
        <option value="youtube">YouTube ‚Äì Standard (16:9)</option>
        <option value="reels">Instagram Reels</option>
        <option value="stories">Instagram Stories</option>
      </select>
    </div>

    <!-- LOGO -->
    <div class="form-group">
      <label>üñºÔ∏è Logo Upload</label>
      <div class="upload-box">
        <input type="file" id="logoInput" accept="image/*">
        <div class="upload-icon">üì∑</div>
        <div class="upload-text">Click to upload logo</div>
        <div class="file-info" id="logoInfo">PNG or SVG recommended</div>
      </div>
    </div>

    <!-- MEDIA (IMAGE / VIDEO) -->
    <div class="form-group">
      <label>üì∏ Photo / Video Upload</label>
      <div class="upload-box">
        <input type="file" id="mediaInput" accept="image/*,video/*">
        <div class="upload-icon">üé•</div>
        <div class="upload-text">Click to upload photo or video</div>
        <div class="file-info" id="mediaInfo">Images or MP4 videos</div>
      </div>
      <div class="video-processing-hint">
        üí° Tip: If you upload a video, the banner will be over‚Äëlaid on the whole video.
      </div>
    </div>

    <!-- ENGLISH HEADLINE -->
    <div class="form-group">
      <label>‚úçÔ∏è English Headline</label>
      <textarea id="captionEN">HASINA BUILT A MOSQUE IN DHAKA; WHAT WOULD BNP DO?</textarea>
    </div>

    <!-- BANGLA HEADLINE -->
    <div class="form-group">
      <label>‚úçÔ∏è ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ</label>
      <textarea id="captionBN" class="bangla-text">‡¶π‡¶æ‡¶∏‡¶ø‡¶®‡¶æ ‡¶∏‡ßå‡¶¶‡¶ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶¢‡¶æ‡¶ï‡¶æ‡¶Ø‡¶º ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá; BNP ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ‡¶Ø‡¶º ‡¶ó‡ßá‡¶≤‡ßá ‡¶Æ‡¶®‡ßç‡¶¶‡¶ø‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶¨‡ßá?</textarea>
    </div>

    <!-- VIDEO SETTINGS -->
    <div class="video-options">
      <h4>üé¨ Video Settings</h4>

      <div class="option-row">
        <label for="videoDuration">Duration (seconds)</label>
        <input type="number" id="videoDuration" min="2" max="10" value="5">
      </div>

      <!-- HEADLINE ANIMATION selector -->
      <div class="option-row">
        <label for="headlineAnimation">Headline Animation</label>
        <select id="headlineAnimation">
          <option value="typewriter">Typewriter</option>
          <option value="fade">Fade In/Out</option>
          <option value="slide">Slide Up</option>
          <option value="bounce">Bounce</option>
        </select>
      </div>
    </div>

    <!-- ADVANCED OPTIONS -->
    <div class="advanced-toggle" onclick="toggleAdvancedOptions()">
      <span>‚öôÔ∏è Advanced Options</span>
      <span id="advancedArrow">‚ñº</span>
    </div>
    <div class="advanced-content" id="advancedContent">
      <div class="range-row">
        <label for="animationSpeed">Animation Speed</label>
        <input type="range" id="animationSpeed" min="0.5" max="3" step="0.1" value="1">
      </div>

      <div class="range-row">
        <label for="zoomEffect">Zoom Intensity</label>
        <input type="range" id="zoomEffect" min="0" max="20" step="1" value="5">
      </div>

      <div class="quality-selector">
        <label>Video Quality: <span id="qualityValue">75%</span></label>
        <input type="range" id="quality" min="50" max="90" value="75" step="5">
      </div>
    </div>

    <!-- PROCESSING CONTROLS -->
    <div class="processing-controls">
      <button class="btn-control" id="cancelBtn" style="display:none" onclick="cancelProcessing()">Cancel</button>
      <button class="btn-control" id="pauseBtn" style="display:none" onclick="pauseProcessing()">Pause</button>
    </div>

    <div class="memory-indicator" id="memoryIndicator">
      ‚ö†Ô∏è High memory usage detected. Close other tabs for best results.
    </div>

    <!-- DOWNLOAD SECTION (IMAGES) -->
    <div class="btn-section">
      <h3>üì• Download Static Images</h3>
      <button class="btn-download btn-english" onclick="downloadBanner('english','image')">
        Download English Image (JPG)
      </button>
      <button class="btn-download btn-bangla" onclick="downloadBanner('bangla','image')">
        ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶õ‡¶¨‡¶ø ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® (JPG)
      </button>
    </div>

    <!-- DOWNLOAD SECTION (VIDEOS) -->
    <div class="btn-section">
      <h3>üé¨ Download Videos</h3>
      <div class="option-row">
        <button class="btn-download btn-video" style="flex:1"
                onclick="downloadBanner('english','mp4')">MP4 Video</button>
        <button class="btn-download btn-video" style="flex:1;margin-left:10px"
                onclick="downloadBanner('bangla','mp4')">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì</button>
      </div>

      <div class="option-row" style="margin-top:10px">
        <button class="btn-download btn-video" style="flex:1;background:#4caf50"
                onclick="downloadBanner('english','reels')">Instagram Reels</button>
        <button class="btn-download btn-video" style="flex:1;margin-left:10px;background:#e91e63"
                onclick="downloadBanner('bangla','reels')">‡¶∞‡¶ø‡¶≤‡¶∏ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
      </div>

      <div class="progress-indicator" id="progressIndicator">
        Preparing for video generation‚Ä¶
      </div>
    </div>
  </div>

  <!-- ==================== PREVIEW SECTION ==================== -->
  <div class="preview-section">

    <!-- ENGLISH PREVIEW -->
    <div class="preview-container">
      <div class="preview-header">
        <h2>English Preview</h2>
        <span class="lang-badge">ENGLISH</span>
      </div>
      <div class="banner-wrapper">
        <div class="banner" id="bannerEN">
          <div class="top-strip">
            <div class="brand-area">
              <img class="brand-logo" id="logoEN"
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='48' viewBox='0 0 200 80'%3E%3Crect fill='%23ffffff' width='200' height='80' rx='10'/%3E%3Ctext x='100' y='50' font-family='Arial' font-size='32' font-weight='bold' fill='%23d32f2f' text-anchor='middle'%3EInfoMela%3C/text%3E%3C/svg%3E"
                alt="Logo" />
              <span class="slogan">News.Fun.Facts</span>
            </div>
            <div class="date-badge" id="dateEN">14 OCTOBER 2025</div>
          </div>

          <div class="image-panel">
            <img id="bgImageEN"
                 src="https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&w=1200&q=80"
                 alt="Headline visual" crossorigin="anonymous" />
            <div class="image-overlay"></div>
          </div>

          <div class="headline-area">
            <div class="headline-text" id="captionDisplayEN"></div>
          </div>

          <div class="cta-ribbon" id="ctaEN">DETAILS IN COMMENTS</div>

          <div class="footer-bar">
            <div class="social-item"><div class="social-icon icon-facebook">f</div><span>@theinfomelaa</span></div>
            <div class="social-item"><div class="social-icon icon-twitter">ùïè</div><span>@theinfomela</span></div>
            <div class="social-item"><div class="social-icon icon-youtube">‚ñ∂</div><span>@theinfomela</span></div>
            <div class="social-item"><div class="social-icon icon-instagram">‚ßâ</div><span>@theinfomela</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- BANGLA PREVIEW -->
    <div class="preview-container">
      <div class="preview-header">
        <h2>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</h2>
        <span class="lang-badge bangla">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span>
      </div>
      <div class="banner-wrapper">
        <div class="banner bangla-text" id="bannerBN">
          <div class="top-strip">
            <div class="brand-area">
              <img class="brand-logo" id="logoBN"
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='48' viewBox='0 0 200 80'%3E%3Crect fill='%23ffffff' width='200' height='80' rx='10'/%3E%3Ctext x='100' y='50' font-family='Arial' font-size='32' font-weight='bold' fill='%23d32f2f' text-anchor='middle'%3E‡¶á‡¶®‡¶´‡ßã ‡¶Æ‡ßá‡¶≤‡¶æ%3C/text%3E%3C/svg%3E"
                alt="Logo" />
              <span class="slogan">‡¶ñ‡¶¨‡¶∞.‡¶Æ‡¶ú‡¶æ.‡¶§‡¶•‡ßç‡¶Ø</span>
            </div>
            <div class="date-badge" id="dateBN">‡ßß‡ß™ ‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞ ‡ß®‡ß¶‡ß®‡ß´</div>
          </div>

          <div class="image-panel">
            <img id="bgImageBN"
                 src="https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&w=1200&q=80"
                 alt="Headline visual" crossorigin="anonymous" />
            <div class="image-overlay"></div>
          </div>

          <div class="headline-area">
            <div class="headline-text" id="captionDisplayBN"></div>
          </div>

          <div class="cta-ribbon" id="ctaBN">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá</div>

          <div class="footer-bar">
            <div class="social-item"><div class="social-icon icon-facebook">f</div><span>@theinfomelaa</span></div>
            <div class="social-item"><div class="social-icon icon-twitter">ùïè</div><span>@theinfomela</span></div>
            <div class="social-item"><div class="social-icon icon-youtube">‚ñ∂</div><span>@theinfomela</span></div>
            <div class="social-item"><div class="social-icon icon-instagram">‚ßâ</div><span>@theinfomela</span></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!--------------------------------------------------------------
   ====================== SCRIPT SECTION =======================
-------------------------------------------------------------->

<script>
/* --------------------------------------------------------------
   1Ô∏è‚É£  GLOBAL CONSTANTS & STATE
   -------------------------------------------------------------- */
const PLATFORM_RATIOS = {
  'fb-square':      {width:1080, height:1080, crop:'center'},
  'fb-landscape':   {width:1280, height:720,  crop:'center'},
  'fb-portrait':    {width:1080, height:1350, crop:'center'},
  'twitter-landscape':{width:1280,height:720,  crop:'center'},
  'twitter-square': {width:1080, height:1080, crop:'center'},
  'ig-feed':        {width:1080, height:1080, crop:'center'},
  'ig-portrait':    {width:1080, height:1350, crop:'center'},
  'ig-story':       {width:1080, height:1920, crop:'top'},
  'youtube':        {width:1920, height:1080, crop:'center'},
  'reels':          {width:1080, height:1920, crop:'top'},
  'stories':        {width:1080, height:1920, crop:'top'}
};

const state = {
  logoObjectURL: null,
  mediaObjectURL: null,
  mediaType: 'image',          // 'image' | 'video'
  processing: false,
  currentProcess: null,
  pauseRequested: false,
  processedFrames: 0,
  totalFrames: 0,
  currentLang: null,
  currentType: null,
  headlineAnim: 'typewriter'
};

const videoConfig = {
  duration: 5,
  fps: 24,
  animationSpeed: 1,
  zoomEffect: 5,
  quality: 75
};

/* --------------------------------------------------------------
   2Ô∏è‚É£  INITIALISE UI
   -------------------------------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
  initUI();
  setupEventListeners();
});

function initUI() {
  const today = new Date();
  document.getElementById('bannerDate').value = today.toISOString().split('T')[0];
  updateDate();
  updateCaptions();
  updatePlatformRatio();
}

function setupEventListeners() {
  document.getElementById('bannerDate').addEventListener('change', updateDate);
  document.getElementById('platformSelect').addEventListener('change', updatePlatformRatio);
  document.getElementById('captionEN').addEventListener('input', updateCaptions);
  document.getElementById('captionBN').addEventListener('input', updateCaptions);
  document.getElementById('logoInput').addEventListener('change', handleLogoUpload);
  document.getElementById('mediaInput').addEventListener('change', handleMediaUpload);
  document.getElementById('videoDuration').addEventListener('change', e => {
    const v = Math.max(2, Math.min(10, Number(e.target.value) || 5));
    videoConfig.duration = v; e.target.value = v;
  });
  document.getElementById('quality').addEventListener('input', e => {
    const val = Number(e.target.value);
    videoConfig.quality = val;
    document.getElementById('qualityValue').textContent = `${val}%`;
  });
  document.getElementById('animationSpeed').addEventListener('input', e => videoConfig.animationSpeed = Number(e.target.value));
  document.getElementById('zoomEffect').addEventListener('input', e => videoConfig.zoomEffect = Number(e.target.value));
  document.getElementById('headlineAnimation').addEventListener('change', e => state.headlineAnim = e.target.value);
  setInterval(checkMemoryUsage, 5000);
}

/* --------------------------------------------------------------
   3Ô∏è‚É£  MEMORY USAGE INDICATOR
   -------------------------------------------------------------- */
function checkMemoryUsage() {
  const ind = document.getElementById('memoryIndicator');
  if (navigator.storage && navigator.storage.estimate) {
    navigator.storage.estimate().then(e => {
      const used = e.usage || 0;
      const total = e.quota || 1e9;
      ind.style.display = ((used/total)*100 > 85) ? 'block' : 'none';
    });
  }
}

/* --------------------------------------------------------------
   4Ô∏è‚É£  UI HELPERS (date, captions, platform, etc.)
   -------------------------------------------------------------- */
function updateDate() {
  const val = document.getElementById('bannerDate').value;
  if (!val) return;
  const d = new Date(val + 'T00:00:00');

  const enOpts = {year:'numeric', month:'long', day:'numeric'};
  document.getElementById('dateEN').textContent = d.toLocaleDateString('en-GB', enOpts).toUpperCase();

  const bnMonths = ['‡¶ú‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø','‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø','‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö','‡¶è‡¶™‡ßç‡¶∞‡¶ø‡¶≤','‡¶Æ‡ßá','‡¶ú‡ßÅ‡¶®','‡¶ú‡ßÅ‡¶≤‡¶æ‡¶á','‡¶Ü‡¶ó‡¶∏‡ßç‡¶ü','‡¶∏‡ßá‡¶™‡ßç‡¶ü‡ßá‡¶Æ‡ßç‡¶¨‡¶∞','‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞','‡¶®‡¶≠‡ßá‡¶Æ‡ßç‡¶¨‡¶∞','‡¶°‡¶ø‡¶∏‡ßá‡¶Æ‡ßç‡¶¨‡¶∞'];
  const bnDay = d.getDate();
  const bnMonth = bnMonths[d.getMonth()];
  const bnYear = d.getFullYear();
  document.getElementById('dateBN').textContent = `${bnDay} ${bnMonth} ${bnYear}`;
}

function updateCaptions() {
  const en = document.getElementById('captionEN').value.trim();
  const bn = document.getElementById('captionBN').value.trim();
  document.getElementById('captionDisplayEN').textContent = en;
  document.getElementById('captionDisplayBN').textContent = bn;
  adjustFontSize('captionDisplayEN', en.length);
  adjustFontSize('captionDisplayBN', bn.length);
  updatePlatformRatio();
}

function adjustFontSize(elId, len) {
  const el = document.getElementById(elId);
  const base = 1.85;
  const size = Math.max(1.0, base - (len/180));
  el.style.fontSize = `${size}rem`;
  if (len > 100) {
    el.style.wordBreak = 'break-word';
    el.style.overflowWrap = 'break-word';
  } else {
    el.style.wordBreak = 'normal';
    el.style.overflowWrap = 'normal';
  }
}

function updatePlatformRatio() {
  const platform = document.getElementById('platformSelect').value;
  const ratio = PLATFORM_RATIOS[platform];
  const base = 700;

  document.querySelectorAll('.banner-wrapper').forEach(wrapper => {
    const banner = wrapper.querySelector('.banner');
    wrapper.style.width = `${base}px`;
    const expectedH = Math.round((ratio.height/ratio.width) * base);
    const contentH = banner.scrollHeight + 40;
    wrapper.style.height = `${Math.max(expectedH, contentH)}px`;

    const ctaEN = document.getElementById('ctaEN');
    const ctaBN = document.getElementById('ctaBN');
    const isVertical = ['ig-story','reels','stories'].includes(platform);
    ctaEN.style.display = isVertical ? 'none' : 'block';
    ctaBN.style.display = isVertical ? 'none' : 'block';
  });
}

function toggleAdvancedOptions() {
  const c = document.getElementById('advancedContent');
  const a = document.getElementById('advancedArrow');
  c.classList.toggle('active');
  a.textContent = c.classList.contains('active') ? '‚ñ≤' : '‚ñº';
}

/* --------------------------------------------------------------
   5Ô∏è‚É£  MEDIA HANDLING (logo, image, video)
   -------------------------------------------------------------- */
function handleLogoUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  document.getElementById('logoInfo').textContent = file.name;
  if (state.logoObjectURL) URL.revokeObjectURL(state.logoObjectURL);
  const reader = new FileReader();
  reader.onload = ev => {
    const data = ev.target.result;
    state.logoObjectURL = data;
    document.getElementById('logoEN').src = data;
    document.getElementById('logoBN').src = data;
  };
  reader.readAsDataURL(file);
}

function handleMediaUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const isVideo = file.type.startsWith('video/');
  const sizeMB = (file.size/1024/1024).toFixed(1);
  document.getElementById('mediaInfo').textContent = isVideo ?
        `Video: ${file.name} (${sizeMB}‚ÄØMB)` :
        `Image: ${file.name} (${sizeMB}‚ÄØMB)`;

  if (isVideo) {
    handleVideoUpload(file);
  } else {
    handleImageUpload(file);
  }
}

function handleImageUpload(file) {
  if (state.mediaObjectURL) URL.revokeObjectURL(state.mediaObjectURL);
  const reader = new FileReader();
  reader.onload = ev => {
    const data = ev.target.result;
    state.mediaObjectURL = data;
    state.mediaType = 'image';
    document.getElementById('bgImageEN').src = data;
    document.getElementById('bgImageBN').src = data;
  };
  reader.readAsDataURL(file);
}

function handleVideoUpload(file) {
  if (state.mediaObjectURL) URL.revokeObjectURL(state.mediaObjectURL);
  const video = document.createElement('video');
  video.preload = 'metadata';
  video.muted = true;
  video.src = URL.createObjectURL(file);

  video.onloadedmetadata = () => {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
    state.mediaObjectURL = dataUrl;
    state.mediaType = 'video';
    document.getElementById('bgImageEN').src = dataUrl;
    document.getElementById('bgImageBN').src = dataUrl;
    URL.revokeObjectURL(video.src);
  };
}

/* --------------------------------------------------------------
   6Ô∏è‚É£  MAIN EXPORT FUNCTION (image / video)
   -------------------------------------------------------------- */
async function downloadBanner(lang, type) {
  if (state.processing) {
    alert('Please wait for the current process to finish.');
    return;
  }

  // Check for WebCodecs support
  if ((type === 'mp4' || type === 'reels') && typeof VideoEncoder === 'undefined') {
      alert('Video export is not supported in your browser. Please use a modern browser like Google Chrome or Microsoft Edge.');
      return;
  }

  state.processing = true;
  state.currentLang = lang;
  state.currentType = type;

  const platform = document.getElementById('platformSelect').value;
  const ratio = PLATFORM_RATIOS[platform];
  const bannerId = lang === 'english' ? 'bannerEN' : 'bannerBN';
  const ctaId = lang === 'english' ? 'ctaEN' : 'ctaBN';
  const cta = document.getElementById(ctaId);

  if (['ig-story','reels','stories'].includes(platform)) cta.style.display = 'none';

  const progress = document.getElementById('progressIndicator');
  const cancelBtn = document.getElementById('cancelBtn');
  const pauseBtn  = document.getElementById('pauseBtn');

  progress.className = 'progress-indicator active';
  progress.textContent = 'Preparing export‚Ä¶';
  cancelBtn.style.display = 'inline-block';
  pauseBtn.style.display = 'inline-block';
  state.pauseRequested = false;

  try {
    if (type === 'image') {
      await downloadImage(bannerId, ratio);
    } else if (type === 'mp4' || type === 'reels') {
      const frames = await generateFrames(bannerId, ratio);
      await exportToMP4(frames, lang, ratio);
    } else {
      throw new Error('Unsupported export type');
    }
  } catch (err) {
    console.error(err);
    progress.textContent = `Error: ${err.message}`;
    setTimeout(() => progress.className = 'progress-indicator', 3000);
    if (!state.pauseRequested) alert(`Processing failed: ${err.message}`);
  } finally {
    const isVertical = ['ig-story','reels','stories'].includes(platform);
    cta.style.display = isVertical ? 'none' : 'block';
    cancelBtn.style.display = 'none';
    pauseBtn.style.display = 'none';
    state.processing = false;
    state.currentProcess = null;
  }
}

/* --------------------------------------------------------------
   7Ô∏è‚É£  IMAGE EXPORT (high‚Äëquality)
   -------------------------------------------------------------- */
async function downloadImage(bannerId, ratio) {
  const progress = document.getElementById('progressIndicator');
  const banner = document.getElementById(bannerId);
  progress.textContent = 'Rendering high‚Äëres image‚Ä¶';

  const canvas = await html2canvas(banner, {
    scale: 4,
    useCORS: true,
    allowTaint: true,
    backgroundColor: '#ffffff',
    logging: false,
    imageTimeout: 0,
    removeContainer: true
  });

  const out = document.createElement('canvas');
  out.width = ratio.width;
  out.height = ratio.height;
  const ctx = out.getContext('2d');
  ctx.imageSmoothingEnabled = true;
  ctx.imageSmoothingQuality = 'high';
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, out.width, out.height);
  ctx.drawImage(canvas, 0, 0, out.width, out.height);

  progress.textContent = 'Preparing download‚Ä¶';
  out.toBlob(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `InfoMela_${bannerId.includes('EN') ? 'EN' : 'BN'}_${Date.now()}.jpg`;
    a.click();
    URL.revokeObjectURL(url);
    progress.textContent = 'Image downloaded!';
    setTimeout(() => progress.className = 'progress-indicator', 2000);
  }, 'image/jpeg', 0.98);
}

/* --------------------------------------------------------------
   8Ô∏è‚É£  VIDEO FRAME GENERATION
   -------------------------------------------------------------- */
async function generateFrames(bannerId, ratio) {
  if (state.mediaType === 'video') {
    return await generateFramesWithVideoBackground(bannerId, ratio);
  } else {
    return await generateFramesWithStaticBackground(bannerId, ratio);
  }
}

async function generateFramesWithStaticBackground(bannerId, ratio) {
    const progress = document.getElementById('progressIndicator');
    const bannerEl = document.getElementById(bannerId);
    const wrapper = bannerEl.parentElement;

    const bannerCanvas = await html2canvas(wrapper, {
        width: ratio.width,
        height: ratio.height,
        scale: 1.5,
        logging: false,
        useCORS: true,
        allowTaint: true
    });

    const totalFrames = videoConfig.duration * videoConfig.fps;
    const procCanvas = document.createElement('canvas');
    procCanvas.width = ratio.width;
    procCanvas.height = ratio.height;
    const ctx = procCanvas.getContext('2d');
    const frames = [];

    for (let i = 0; i < totalFrames; i++) {
        if (state.pauseRequested) throw new Error('Processing cancelled');

        const prog = i / totalFrames;
        const zoom = 1 + (videoConfig.zoomEffect / 100) * Math.sin(prog * Math.PI);
        const panX = Math.sin(prog * Math.PI * 2) * 15 * videoConfig.animationSpeed;
        const panY = Math.cos(prog * Math.PI * 2) * 8 * videoConfig.animationSpeed;

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, ratio.width, ratio.height);
        ctx.save();
        ctx.translate(ratio.width / 2 + panX, ratio.height / 2 + panY);
        ctx.scale(zoom, zoom);
        ctx.drawImage(bannerCanvas, -ratio.width / 2, -ratio.height / 2);
        ctx.restore();

        const bmp = await createImageBitmap(procCanvas);
        frames.push(bmp);

        if (i % 10 === 0) {
            progress.textContent = `Generating frames: ${Math.round((i / totalFrames) * 100)}%`;
        }
    }
    return frames;
}


async function generateFramesWithVideoBackground(bannerId, ratio) {
    const progress = document.getElementById('progressIndicator');
    const bannerEl = document.getElementById(bannerId);
    const wrapper = bannerEl.parentElement;
    const file = document.getElementById('mediaInput').files[0];

    const bannerCanvas = await html2canvas(wrapper, {
        width: ratio.width,
        height: ratio.height,
        scale: 1.5,
        logging: false,
        useCORS: true,
        allowTaint: true,
        backgroundColor: null // Make it transparent
    });

    const video = document.createElement('video');
    video.preload = 'auto';
    video.muted = true;
    video.src = URL.createObjectURL(file);
    await new Promise(res => video.onloadeddata = res);

    const maxDur = Math.min(video.duration, videoConfig.duration);
    const totalFrames = Math.floor(maxDur * videoConfig.fps);
    const procCanvas = document.createElement('canvas');
    procCanvas.width = ratio.width;
    procCanvas.height = ratio.height;
    const ctx = procCanvas.getContext('2d');
    const frames = [];

    for (let i = 0; i < totalFrames; i++) {
        if (state.pauseRequested) throw new Error('Processing cancelled');

        const t = i / videoConfig.fps;
        video.currentTime = t;
        await new Promise(r => video.onseeked = r);

        ctx.drawImage(video, 0, 0, ratio.width, ratio.height);
        ctx.drawImage(bannerCanvas, 0, 0, ratio.width, ratio.height); // Overlay the transparent banner

        const bmp = await createImageBitmap(procCanvas);
        frames.push(bmp);

        if (i % 5 === 0) {
            progress.textContent = `Processing video frames: ${i}/${totalFrames}`;
        }
    }

    URL.revokeObjectURL(video.src);
    return frames;
}


/* --------------------------------------------------------------
   9Ô∏è‚É£  EXPORT TO MP4 (using WebCodecs)
   -------------------------------------------------------------- */
async function exportToMP4(frames, lang, ratio) {
  const progress = document.getElementById('progressIndicator');
  progress.textContent = 'Initializing video encoder‚Ä¶';

  const { Mp4Muxer } = self.Mp4Muxer;
  let muxer = new Mp4Muxer({
      target: 'buffer',
      video: {
          codec: 'avc',
          width: ratio.width,
          height: ratio.height,
          frameRate: videoConfig.fps
      },
  });

  // Map quality slider (50-90%) to a bitrate
  const qualityBitrate = (videoConfig.quality / 100) * 8_000_000 + 2_000_000; // 2-10 Mbps

  const videoEncoder = new VideoEncoder({
    output: (chunk, meta) => muxer.addVideoChunk(chunk, meta),
    error: (e) => console.error('VideoEncoder error:', e.message),
  });
  videoEncoder.configure({
    codec: 'avc1.42001f',
    width: ratio.width,
    height: ratio.height,
    bitrate: qualityBitrate,
    framerate: videoConfig.fps,
    latencyMode: 'quality'
  });

  state.totalFrames = frames.length;
  state.processedFrames = 0;

  for (let i = 0; i < frames.length; i++) {
    if (state.pauseRequested) throw new Error('Processing cancelled');

    const frame = frames[i];
    const videoFrame = new VideoFrame(frame, {
      timestamp: (i * 1e6) / videoConfig.fps,
      duration: 1e6 / videoConfig.fps
    });

    videoEncoder.encode(videoFrame);
    videoFrame.close();
    frame.close(); // Important for memory management

    state.processedFrames++;
    if (i % 10 === 0) {
      progress.textContent = `Encoding video: ${Math.round((i / frames.length) * 100)}%`;
    }
  }

  progress.textContent = 'Finalizing MP4 file‚Ä¶';
  await videoEncoder.flush();
  muxer.finalize();

  const { buffer } = muxer.target;
  const videoBlob = new Blob([buffer], { type: 'video/mp4' });

  downloadBlob(videoBlob, `InfoMela_${lang}_${Date.now()}.mp4`);
  progress.textContent = 'Video downloaded!';
  setTimeout(() => (progress.className = 'progress-indicator'), 2000);
}

/* --------------------------------------------------------------
   10Ô∏è‚É£  DOWNLOAD HELPER
   -------------------------------------------------------------- */
function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 100);
}

/* --------------------------------------------------------------
   11Ô∏è‚É£  PROCESS CONTROLS (pause / cancel)
   -------------------------------------------------------------- */
function cancelProcessing() {
  state.pauseRequested = true;
  document.getElementById('progressIndicator').textContent = 'Cancelling‚Ä¶';
}

function pauseProcessing() {
    alert("Pause/Resume is not supported with this export method. Please cancel and restart.");
}

function resumeProcessing() {
    // This function is kept for UI consistency but is not functional in this version.
}
</script>
</body>
</html>
