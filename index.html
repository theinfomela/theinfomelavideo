<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enhanced InfoMela Studio</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&family=Noto+Sans+Bengali:wght@600;700&display=swap" rel="stylesheet" />
  <style>
    /* Existing Styles Here */
    /*...*/
  </style>
</head>

<body>
<div class="main-container">
  <div class="control-panel">
    <h1>üé¨ InfoMela Studio</h1>
    <p>Create customized banners and looping videos with your unique style!</p>

    <div class="form-group">
      <label>Date</label>
      <input type="date" id="bannerDate"/>
    </div>

    <div class="form-group">
      <label>Platform Ratio</label>
      <select id="platformSelect">
        <option value="fb-square">Facebook Square (1:1)</option>
        <option value="youtube">YouTube Landscape (16:9)</option>
        <option value="ig-story">Instagram Story (9:16)</option>
      </select>
    </div>

    <div class="form-group">
      <label>Logo Upload</label>
      <div class="upload-box" onclick="document.getElementById('logoInput').click()">
        <input type="file" id="logoInput" accept="image/*" style="display:none;"/>
        <div class="upload-icon">üì∑</div>
        <div class="file-info" id="logoInfo">PNG/SVG recommended</div>
      </div>
    </div>

    <div class="form-group">
      <label>Headline Image</label>
      <div class="upload-box" onclick="document.getElementById('imageInput').click()">
        <input type="file" id="imageInput" accept="image/*" style="display:none;"/>
        <div class="upload-icon">üñºÔ∏è</div>
        <div class="file-info" id="imageInfo">Click to upload</div>
      </div>
    </div>

    <div class="form-group">
      <label>English Headline</label>
      <textarea id="captionEN">HASINA BUILT A MOSQUE IN DHAKA; WHAT WOULD BNP DO?</textarea>
    </div>

    <div class="form-group">
      <label>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ</label>
      <textarea id="captionBN" class="bangla-text">‡¶π‡¶æ‡¶∏‡¶ø‡¶®‡¶æ ‡¶¢‡¶æ‡¶ï‡¶æ‡¶Ø‡¶º ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡ßá; ‡¶¨‡¶ø‡¶è‡¶®‡¶™‡¶ø ‡¶ï‡ßÄ ‡¶ï‡¶∞‡¶¨‡ßá?</textarea>
    </div>

    <div class="form-group">
      <label>Video Duration (30‚Äì120s)</label>
      <input type="number" id="videoDuration" min="30" max="120" value="60"/>
    </div>
    <div class="form-group">
      <label>Zoom Intensity (0‚Äì30)</label>
      <input type="range" id="zoomEffect" min="0" max="30" step="1" value="5"/>
    </div>

    <div class="btn-download btn-english" onclick="downloadBanner('english','image')">Download English Image</div>
    <div class="btn-download btn-bangla" onclick="downloadBanner('bangla','image')">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶õ‡¶¨‡¶ø ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</div>
    <div class="btn-download btn-video" id="btnVideoEN" onclick="downloadBanner('english','video')">üé• Download English Video</div>
    <div class="btn-download btn-video" id="btnVideoBN" onclick="downloadBanner('bangla','video')">üé• ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</div>
    <div class="progress-indicator" id="progressIndicator"></div>
  </div>

  <!-- PREVIEW -->
  <div class="preview-section">
    <div class="preview-container">
      <h2>English Preview</h2>
      <div class="banner-wrapper" id="wrapperEN">
        <div class="banner" id="bannerEN">
          <div class="top-strip"><div class="brand-area"><img id="logoEN" class="brand-logo" src="" alt="Logo"/><span class="slogan">News. Fun. Facts.</span></div><div id="dateEN"></div></div>
          <div class="image-panel"><img id="bgImageEN" src="" alt=""/></div>
          <div class="headline-area"><div id="captionDisplayEN" class="headline-text"></div></div>
          <div class="cta-ribbon" id="ctaEN">DETAILS BELOW</div>
          <div class="footer-bar">
            <div class="social-item"><div class="social-icon icon-facebook">f</div><span>@theinfomelaa</span></div>
            <div class="social-item"><div class="social-icon icon-twitter">ùïè</div><span>@theinfomela</span></div>
            <div class="social-item"><div class="social-icon icon-youtube">‚ñ∂</div><span>@theinfomela</span></div>
            <div class="social-item"><div class="social-icon icon-instagram">‚ßâ</div><span>@theinfomela</span></div>
          </div>
        </div>
      </div>
    </div>
    <div class="preview-container">
      <h2>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</h2>
      <div class="banner-wrapper" id="wrapperBN">
        <div class="banner bangla-text" id="bannerBN">
          <div class="top-strip"><div class="brand-area"><img id="logoBN" class="brand-logo" src="" alt="Logo"/><span class="slogan">‡¶ñ‡¶¨‡¶∞. ‡¶Æ‡¶ú‡¶æ. ‡¶§‡¶•‡ßç‡¶Ø.</span></div><div id="dateBN"></div></div>
          <div class="image-panel"><img id="bgImageBN" src="" alt=""/></div>
          <div class="headline-area"><div id="captionDisplayBN" class="headline-text"></div></div>
          <div class="cta-ribbon" id="ctaBN">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶®‡¶ø‡¶ö‡ßá</div>
          <div class="footer-bar">
            <div class="social-item"><div class="social-icon icon-facebook">f</div><span>@theinfomelaa</span></div>
            <div class="social-item"><div class="social-icon icon-twitter">ùïè</div><span>@theinfomela</span></div>
            <div class="social-item"><div class="social-icon icon-youtube">‚ñ∂</div><span>@theinfomela</span></div>
            <div class="social-item"><div class="social-icon icon-instagram">‚ßâ</div><span>@theinfomela</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const PLATFORM_RATIOS = {
  'fb-square': { width:1080, height:1080 },
  'youtube': { width:1920, height:1080 },
  'ig-story': { width:1080, height:1920 }
};
const state = { backgroundColor: '#fff', logoURL: null, photoURL: null };
const videoConfig = { duration: 60, fps: 30, zoomEffect: 5 };

document.addEventListener('DOMContentLoaded', () => {
  const today = new Date(); document.getElementById('bannerDate').value = today.toISOString().split('T')[0];
  updateDate(); updateCaptions();
  document.getElementById('bannerDate').addEventListener('change', updateDate);
  document.getElementById('captionEN').addEventListener('input', updateCaptions);
  document.getElementById('captionBN').addEventListener('input', updateCaptions);
  document.getElementById('logoInput').addEventListener('change', handleLogoUpload);
  document.getElementById('imageInput').addEventListener('change', handleImageUpload);
  document.getElementById('videoDuration').addEventListener('input', e => {
    videoConfig.duration = Math.min(120, Math.max(30, Number(e.target.value)));
  });
  document.getElementById('zoomEffect').addEventListener('input', e => {
    videoConfig.zoomEffect = Number(e.target.value);
  });
});

function updateDate() {
  const val = document.getElementById('bannerDate').value; if (!val) return;
  const date = new Date(val);
  document.getElementById('dateEN').textContent = date.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase();
  document.getElementById('dateBN').textContent = `${date.getDate()} ‡¶Ö‡¶ï‡ßç‡¶ü‡ßã‡¶¨‡¶∞ ${date.getFullYear()}`;
}

function updateCaptions() {
  document.getElementById('captionDisplayEN').textContent = document.getElementById('captionEN').value;
  document.getElementById('captionDisplayBN').textContent = document.getElementById('captionBN').value;
  adjustFontSize('captionDisplayEN', document.getElementById('captionEN').value.length);
  adjustFontSize('captionDisplayBN', document.getElementById('captionBN').value.length);
  updatePlatformRatio();
}

function adjustFontSize(elementId, length) {
  const el = document.getElementById(elementId);
  const baseSize = 1.6;
  const size = Math.max(1.2, baseSize - (length / 150));
  el.style.fontSize = `${size}rem`;
}

function handleLogoUpload(e) {
  const file = e.target.files[0]; if (!file) return;
  if (state.logoURL) URL.revokeObjectURL(state.logoURL);
  state.logoURL = URL.createObjectURL(file);
  document.getElementById('logoInfo').textContent = file.name;
  document.getElementById('logoEN').src = state.logoURL;
  document.getElementById('logoBN').src = state.logoURL;
  extractDominantColor(state.logoURL);
}

function handleImageUpload(e) {
  const file = e.target.files[0]; if (!file) return;
  if (state.photoURL) URL.revokeObjectURL(state.photoURL);
  state.photoURL = URL.createObjectURL(file);
  document.getElementById('imageInfo').textContent = file.name;
  document.getElementById('bgImageEN').src = state.photoURL;
  document.getElementById('bgImageBN').src = state.photoURL;
}

function extractDominantColor(src) {
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);
    const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    let r = 0, g = 0, b = 0, count = 0;

    for (let i = 0; i < data.length; i += 4) {
      if (data[i + 3] > 120) {
        r += data[i];
        g += data[i + 1];
        b += data[i + 2];
        count++;
      }
    }
    if (!count) return;

    r = Math.round(r / count);
    g = Math.round(g / count);
    b = Math.round(b / count);
    const hex = `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase()}`;
    applyBrandColor(hex);
  };
  img.src = src;
}

function applyBrandColor(color) {
  const darker = shadeColor(color, -35);
  const lighter = shadeColor(color, -15);

  document.querySelectorAll('.banner-wrapper').forEach(wrapper => wrapper.style.borderColor = color);
  document.querySelectorAll('.top-strip').forEach(el => el.style.background = `linear-gradient(90deg, ${color} 0%, ${darker} 100%)`);
  document.querySelectorAll('.cta-ribbon').forEach(el => el.style.background = `linear-gradient(90deg, ${color} 0%, ${darker} 100%)`);
  document.querySelectorAll('.headline-area').forEach(el => el.style.borderColor = `${color}55`);
  document.querySelectorAll('.headline-text').forEach(el => el.style.color = lighter);
  document.querySelectorAll('.image-panel').forEach(el => el.style.borderColor = `${color}DD`);
  document.querySelectorAll('.footer-bar').forEach(el => el.style.borderTopColor = `${color}CC`);
}

function shadeColor(color, percent) {
  const num = parseInt(color.slice(1), 16);
  const amt = Math.round(2.55 * percent);
  const R = Math.min(255, Math.max(0, (num >> 16) + amt));
  const G = Math.min(255, Math.max(0, (num >> 8 & 0x00ff) + amt));
  const B = Math.min(255, Math.max(0, (num & 0x0000ff) + amt));
  return `#${(R << 16 | G << 8 | B).toString(16).padStart(6, '0').toUpperCase()}`;
}

function updatePlatformRatio() {
  const platform = document.getElementById('platformSelect').value;
  const ratio = PLATFORM_RATIOS[platform];
  const baseWidth = 700;

  document.querySelectorAll('.banner-wrapper').forEach(wrapper => {
    const banner = wrapper.querySelector('.banner');
    const ratioHeight = Math.round((ratio.height / ratio.width) * baseWidth);
    const contentHeight = banner.scrollHeight + 40;
    wrapper.style.width = `${baseWidth}px`;
    wrapper.style.height = `${Math.max(ratioHeight, contentHeight)}px`;
  });
}

async function downloadBanner(lang, type) {
  const wrapperId = lang === 'english' ? 'wrapperEN' : 'wrapperBN';
  const bannerId = lang === 'english' ? 'bannerEN' : 'bannerBN';
  const platform = document.getElementById('platformSelect').value;
  const ratio = PLATFORM_RATIOS[platform];
  const banner = document.getElementById(bannerId);

  if (type === 'video') document.getElementById(wrapperId).classList.add('hidden');

  try {
    if (type === 'image') {
      await downloadImage(banner, lang, ratio);
    } else {
      await downloadVideo(banner, lang, ratio);
    }
  } finally {
    if (type === 'video') document.getElementById(wrapperId).classList.remove('hidden');
  }
}

async function downloadImage(banner, lang, ratio) {
  try {
    banner.querySelectorAll('img').forEach(img => { if (img.src.startsWith('http')) img.crossOrigin = 'anonymous'; });
    const canvas = await html2canvas(banner, { scale: 4, backgroundColor: state.backgroundColor, useCORS: true });
    const finalCanvas = document.createElement('canvas');
    finalCanvas.width = ratio.width * 2;
    finalCanvas.height = ratio.height * 2;
    const ctx = finalCanvas.getContext('2d');
    ctx.fillStyle = state.backgroundColor;
    ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
    ctx.drawImage(canvas, 0, 0, finalCanvas.width, finalCanvas.height);
    const link = document.createElement('a');
    link.download = `InfoMela_${lang}_${Date.now()}.png`;
    link.href = finalCanvas.toDataURL('image/png', 1.0);
    link.click();
  } catch (err) {
    console.error(err);
    alert('Image download failed. Try using local or same-origin images.');
  }
}

async function downloadVideo(banner, lang, ratio) {
  const progress = document.getElementById('progressIndicator');
  const btnEN = document.getElementById('btnVideoEN');
  const btnBN = document.getElementById('btnVideoBN');

  btnEN.disabled = true;
  btnBN.disabled = true;
  progress.classList.add('active');
  progress.textContent = 'Rendering video‚Ä¶';

  try {
    const snapshot = await html2canvas(banner, { scale: 4, backgroundColor: '#fff', useCORS: true });
    const image = await canvasToImage(snapshot);
    const canvas = document.createElement('canvas');
    canvas.width = ratio.width * 2;
    canvas.height = ratio.height * 2;
    const ctx = canvas.getContext('2d');
    const mime = MediaRecorder.isTypeSupported('video/webm;codecs=vp8') ? 'video/webm;codecs=vp8' : 'video/webm';
    const stream = canvas.captureStream(videoConfig.fps);
    const recorder = new MediaRecorder(stream, { mimeType: mime });
    const chunks = [];
    recorder.ondataavailable = e => e.data.size && chunks.push(e.data);

    const totalFrames = Math.floor(videoConfig.duration * videoConfig.fps);
    recorder.start();
    let frame = 0;

    function drawFrame() {
      const p = (frame % totalFrames) / totalFrames;
      drawAnimatedFrame(ctx, image, canvas.width, canvas.height, p);
      frame++;
      if (frame < totalFrames) setTimeout(drawFrame, 1000 / videoConfig.fps);
      else recorder.stop();
    }

    drawFrame();
    await new Promise(r => recorder.onstop = r);

    const blob = new Blob(chunks, { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `InfoMela_${lang}_${Date.now()}.webm`;
    a.click();
    URL.revokeObjectURL(url);
  } catch (err) {
    console.error(err);
    alert('Video generation failed.');
  } finally {
    progress.classList.remove('active');
    btnEN.disabled = false;
    btnBN.disabled = false;
  }
}

function drawAnimatedFrame(ctx, img, w, h, p) {
  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, w, h);
  const zoom = 1 + (Math.sin(p * Math.PI * 2) * (videoConfig.zoomEffect / 100));
  const offsetX = Math.sin(p * Math.PI) * 10;
  const offsetY = Math.cos(p * Math.PI) * 5;
  ctx.save();
  ctx.translate(w / 2 + offsetX, h / 2 + offsetY);
  ctx.scale(zoom, zoom);
  ctx.drawImage(img, -w / 2, -h / 2, w, h);
  ctx.restore();
}

function canvasToImage(canvas) {
  return new Promise(res => {
    const img = new Image();
    img.onload = () => res(img);
    img.src = canvas.toDataURL('image/png');
  });
}
</script>

</body>
</html>
